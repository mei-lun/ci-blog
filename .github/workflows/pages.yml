name: Pages
on:
  push:
    branches: ["gh-pages"]  # è§¦å‘æ¡ä»¶ä¸å˜

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.head_commit.message, 'deploy')}}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm install

      - name: Build
        run: npm run build  # ç¡®ä¿äº§ç‰©è¾“å‡ºåˆ° ./public

      # ğŸ”¥ ç²¾å‡†æ¸…ç†+è°ƒè¯•ï¼ˆä¸å˜ï¼Œå·²èƒ½æ¸…ç†99%è¿è§„æ–‡ä»¶ï¼‰
      - name: Clean & Debug Invalid Files
        run: |
          echo "=== 1. æŸ¥æ‰¾å¹¶åˆ é™¤æ‰€æœ‰ç¬¦å·é“¾æ¥ï¼ˆæ˜¾ç¤ºå…·ä½“åˆ é™¤çš„æ–‡ä»¶ï¼‰ ==="
          find ./public -type l -print0 | xargs -0 -I {} sh -c 'echo "Deleting symlink: {}"; rm -f {}'

          echo -e "\n=== 2. æŸ¥æ‰¾å¹¶æ›¿æ¢æ‰€æœ‰ç¡¬é“¾æ¥ï¼ˆæ˜¾ç¤ºå…·ä½“æ›¿æ¢çš„æ–‡ä»¶ï¼‰ ==="
          find ./public -type f -links +1 -print0 | xargs -0 -I {} sh -c 'echo "Replacing hardlink: {}"; cp --remove-destination {} {}'

          echo -e "\n=== 3. åˆ é™¤æ‰€æœ‰ç‰¹æ®Šæ–‡ä»¶ï¼ˆè®¾å¤‡/ç®¡é“/å¥—æ¥å­—ï¼‰ ==="
          find ./public -type c -o -type b -o -type p -o -type s -print0 | xargs -0 -I {} sh -c 'echo "Deleting special file: {}"; rm -f {}'

          echo -e "\n=== 4. å¼ºåˆ¶åˆ é™¤éšè—é£é™©æ–‡ä»¶ï¼ˆ.git/.DS_Storeç­‰ï¼‰ ==="
          find ./public -name ".git" -type d -exec echo "Deleting .git dir: {}" \; -exec rm -rf {} +
          find ./public -name ".DS_Store" -exec echo "Deleting .DS_Store: {}" \; -exec rm -f {} +
          find ./public -name "*.lnk" -exec echo "Deleting lnk file: {}" \; -exec rm -f {} +

          echo -e "\n=== 5. æœ€ç»ˆéªŒè¯ï¼šæ˜¯å¦è¿˜æœ‰è¿è§„æ–‡ä»¶ï¼Ÿï¼ˆæ­£å¸¸åº”æ— è¾“å‡ºï¼‰ ==="
          INVALID_FILES=$(find ./public ! -type f ! -type d)
          if [ -n "$INVALID_FILES" ]; then
            echo "âŒ å‘ç°æ®‹ç•™è¿è§„æ–‡ä»¶ï¼š"
            echo "$INVALID_FILES"
            exit 1  # æœ‰è¿è§„æ–‡ä»¶ç›´æ¥ç»ˆæ­¢
          else
            echo "âœ… æ— æ®‹ç•™è¿è§„æ–‡ä»¶ï¼"
          fi

          echo -e "\n=== 6. äº§ç‰©è¯¦æƒ…ï¼ˆç¡®è®¤åˆè§„ï¼‰ ==="
          du -sh ./public  # å†æ¬¡ç¡®è®¤ä½“ç§¯
          ls -la ./public  # æ˜¾ç¤ºæ ¹ç›®å½•æ–‡ä»¶

      # ğŸ”¥ å…³é”®ä¿®å¤ï¼šGNU tar å…¼å®¹çš„éªŒè¯æ–¹å¼ï¼ˆæ›¿æ¢ --exclude-linksï¼‰
      - name: Force Validate with GNU Tar (Reject Links)
        run: |
          echo "=== æ‰“åŒ…äº§ç‰©ï¼Œå¼ºåˆ¶æ‹’ç»é“¾æ¥/ç‰¹æ®Šæ–‡ä»¶ï¼ˆGNU tar å…¼å®¹ç‰ˆï¼‰ ==="
          # GNU tar ç”¨ä»¥ä¸‹å‚æ•°å®ç°ï¼š
          # --dereferenceï¼šæ‰“åŒ…é“¾æ¥æŒ‡å‘çš„å®é™…æ–‡ä»¶ï¼ˆè€Œéé“¾æ¥æœ¬èº«ï¼‰
          # --warning=linkï¼šé‡åˆ°é“¾æ¥æ—¶è¾“å‡ºè­¦å‘Š
          # --no-recursionï¼šä»…æ‰“åŒ…å½“å‰ç›®å½•ï¼ˆé¿å…å­ç›®å½•éšè—é“¾æ¥ï¼Œå¯é€‰ï¼‰
          if ! tar -cf /tmp/public.tar --dereference --warning=link ./public; then
            echo "âŒ Taræ‰“åŒ…å¤±è´¥ï¼äº§ç‰©ä¸­å­˜åœ¨æ— æ³•å¤„ç†çš„è¿è§„æ–‡ä»¶"
            exit 1
          fi
          # é¢å¤–æ£€æŸ¥ï¼šæ‰“åŒ…åéªŒè¯æ˜¯å¦æœ‰é“¾æ¥ç›¸å…³è­¦å‘Šï¼ˆå…œåº•ï¼‰
          if grep -q "link" <(tar -tvf /tmp/public.tar 2>&1); then
            echo "âŒ äº§ç‰©ä¸­å­˜åœ¨é“¾æ¥æ–‡ä»¶ï¼æŸ¥çœ‹ä¸Šæ–¹ tar è­¦å‘Šå®šä½"
            exit 1
          fi
          echo "âœ… Taræ‰“åŒ…æˆåŠŸï¼äº§ç‰©å®Œå…¨åˆè§„"

      # ğŸ”¥ ä¸Šä¼ åˆè§„äº§ç‰©ï¼ˆä¸å˜ï¼‰
      - name: Upload Validated Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages  # å®˜æ–¹å¼ºåˆ¶åç§°
          path: ./public
          retention-days: 1
          if-no-files-found: error
          overwrite: true

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy to Target Repo GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}