name: ci-blog → mei-lun Pages（零提交，修复权限）
on:
  push:
    branches: ["gh-pages"]  # 仅 ci-blog 的 gh-pages 分支触发
jobs:
  build-upload:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'deploy')
    steps:
      - name: Checkout ci-blog (gh-pages)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          ref: gh-pages

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm install --production

      - name: Build Static Files
        run: npm run build  # 产物输出到 ./public

      - name: Upload Pages Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages  # 官方强制名称
          path: ./final-public/
          retention-days: 1
          if-no-files-found: error

  deploy:
    needs: build-upload
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      pages: write  # 部署必需权限
    steps:
      - name: Deploy to mei-lun GitHub Pages（零提交）
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}  # 你的PAT（有权操作mei-lun的Pages）