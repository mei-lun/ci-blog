name: Pages
on:
  push:
    branches: ["gh-pages"]  # è§¦å‘æ¡ä»¶ä¸å˜

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.head_commit.message, 'deploy')}}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm install

      - name: Build
        run: npm run build  # ç¡®ä¿äº§ç‰©è¾“å‡ºåˆ° ./public

      # ğŸ”¥ å…³é”®ä¿®å¤1ï¼šæ¸…ç†äº§ç‰©ä¸­çš„ç¡¬é“¾æ¥/ç¬¦å·é“¾æ¥ï¼ˆéƒ¨ç½²å¤±è´¥æ ¸å¿ƒåŸå› ï¼‰
      - name: Clean Symlinks/Hardlinks in Build Output
        run: |
          # é€’å½’æŸ¥æ‰¾å¹¶åˆ é™¤ç¬¦å·é“¾æ¥
          find ./public -type l -delete
          # é€’å½’æŸ¥æ‰¾å¹¶æ›¿æ¢ç¡¬é“¾æ¥ï¼ˆç”¨æ–‡ä»¶å¤åˆ¶æ›¿ä»£ï¼‰
          find ./public -type f -links +1 -exec cp --remove-destination {} {} \;

      # ğŸ”¥ å…³é”®ä¿®å¤2ï¼šæŒ‰å®˜æ–¹çº¦å®šä¸Šä¼  Artifactï¼ˆåç§°å›ºå®šä¸º github-pagesï¼‰
      - name: Upload Pages Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages  # å®˜æ–¹å¼ºåˆ¶åç§°ï¼Œä¸èƒ½æ”¹
          path: ./public      # äº§ç‰©ç›®å½•
          retention-days: 1  # éƒ¨ç½²åè‡ªåŠ¨æ¸…ç†

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write  # å®˜æ–¹OIDCèº«ä»½éªŒè¯ï¼ˆé…åˆPATè·¨ä»“åº“ï¼‰
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      # ğŸ”¥ å…³é”®ä¿®å¤3ï¼šå»æ‰ä¸æ”¯æŒçš„å‚æ•°ï¼ˆgithub_repositoryã€pathï¼‰
      - name: Deploy to Target Repo GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
        env:
          # æ ¸å¿ƒï¼šç”¨PATæˆæƒè·¨ä»“åº“è®¿é—®ç›®æ ‡ä»“åº“Pages
          GITHUB_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}
        # æ³¨æ„ï¼šv4ç‰ˆæœ¬ä¸éœ€è¦ä¼  github_repository å’Œ pathï¼æ’ä»¶è‡ªåŠ¨è¯»å–Artifact