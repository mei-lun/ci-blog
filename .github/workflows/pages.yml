name: ci-blog â†’ mei-lun Pagesï¼ˆArtifact é›¶æäº¤éƒ¨ç½²ï¼‰
on:
  push:
    branches: ["gh-pages"]  # ä»…è§¦å‘ï¼šci-blog çš„ gh-pages åˆ†æ”¯æ¨é€

jobs:
  build-upload:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'deploy')
    steps:
      - name: Checkout ci-blog (gh-pages)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          ref: gh-pages

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm install --production

      - name: Build Static Files
        run: npm run build  # ç¡®ä¿è¾“å‡ºåˆ° ./public

      - name: Clean Invalid Files (100% Compliance)
        run: |
          find ./public -type l -delete
          find ./public -type c -o -type b -o -type p -o -type s -delete
          find ./public -type f -links +1 -exec cp --remove-destination {} {} \;
          find ./public -name ".git" -exec rm -rf {} +
          find ./public -name ".DS_Store" -delete
          find ./public -name ".*" ! -name ".html" ! -name ".css" ! -name ".js" ! -name ".png" ! -name ".jpg" ! -name ".svg" -delete
          find ./public -type f -exec chmod 644 {} \;
          find ./public -type d -exec chmod 755 {} \;
          INVALID=$(find ./public ! -type f ! -type d)
          [ -n "$INVALID" ] && echo "âŒ Invalid files: $INVALID" && exit 1
          echo "âœ… Build output is compliant"

      - name: Upload Pages Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages  # å®˜æ–¹å¼ºåˆ¶åç§°
          path: ./public/
          retention-days: 1
          if-no-files-found: error

  deploy:
    needs: build-upload
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      pages: write  # ğŸ”¥ è¡¥å…¨å…³é”®æƒé™ï¼éƒ¨ç½² Pages å¿…é¡»å£°æ˜æ­¤æƒé™
    steps:
      - name: Deploy to mei-lun GitHub Pages
        uses: actions/deploy-pages@v4
        env:
          # ğŸ”¥ å¿…é¡»ä½¿ç”¨ mei-lun ä»“åº“æ‰€æœ‰è€…çš„ PATï¼Œä¸”å« pages:write æƒé™
          GITHUB_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}
        with:
          github_repository: mei-lun/mei-lun  # ç›®æ ‡ä»“åº“ï¼Œæ— æ‹¼å†™é”™è¯¯
          timeout: 300
          error_count: 3