name: Pages
on:
  push:
    branches: ["gh-pages"]  # è§¦å‘æ¡ä»¶ä¸å˜

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.head_commit.message, 'deploy')}}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm install

      - name: Build
        run: npm run build  # ç¡®ä¿äº§ç‰©è¾“å‡ºåˆ° ./public

      # ğŸ”¥ æ¸…ç†æ­¥éª¤ä¸å˜ï¼ˆå·²éªŒè¯èƒ½åˆ é™¤æ‰€æœ‰è¿è§„æ–‡ä»¶ï¼Œæ ¸å¿ƒä¿éšœï¼‰
      - name: Clean & Debug Invalid Files
        run: |
          echo "=== 1. æŸ¥æ‰¾å¹¶åˆ é™¤æ‰€æœ‰ç¬¦å·é“¾æ¥ï¼ˆæ˜¾ç¤ºå…·ä½“åˆ é™¤çš„æ–‡ä»¶ï¼‰ ==="
          find ./public -type l -print0 | xargs -0 -I {} sh -c 'echo "Deleting symlink: {}"; rm -f {}'

          echo -e "\n=== 2. æŸ¥æ‰¾å¹¶æ›¿æ¢æ‰€æœ‰ç¡¬é“¾æ¥ï¼ˆæ˜¾ç¤ºå…·ä½“æ›¿æ¢çš„æ–‡ä»¶ï¼‰ ==="
          find ./public -type f -links +1 -print0 | xargs -0 -I {} sh -c 'echo "Replacing hardlink: {}"; cp --remove-destination {} {}'

          echo -e "\n=== 3. åˆ é™¤æ‰€æœ‰ç‰¹æ®Šæ–‡ä»¶ï¼ˆè®¾å¤‡/ç®¡é“/å¥—æ¥å­—ï¼‰ ==="
          find ./public -type c -o -type b -o -type p -o -type s -print0 | xargs -0 -I {} sh -c 'echo "Deleting special file: {}"; rm -f {}'

          echo -e "\n=== 4. å¼ºåˆ¶åˆ é™¤éšè—é£é™©æ–‡ä»¶ï¼ˆ.git/.DS_Storeç­‰ï¼‰ ==="
          find ./public -name ".git" -type d -exec echo "Deleting .git dir: {}" \; -exec rm -rf {} +
          find ./public -name ".DS_Store" -exec echo "Deleting .DS_Store: {}" \; -exec rm -f {} +
          find ./public -name "*.lnk" -exec echo "Deleting lnk file: {}" \; -exec rm -f {} +

          echo -e "\n=== 5. æœ€ç»ˆéªŒè¯ï¼šæ˜¯å¦è¿˜æœ‰è¿è§„æ–‡ä»¶ï¼Ÿï¼ˆæ­£å¸¸åº”æ— è¾“å‡ºï¼‰ ==="
          INVALID_FILES=$(find ./public ! -type f ! -type d)
          if [ -n "$INVALID_FILES" ]; then
            echo "âŒ å‘ç°æ®‹ç•™è¿è§„æ–‡ä»¶ï¼š"
            echo "$INVALID_FILES"
            exit 1  # æœ‰è¿è§„æ–‡ä»¶ç›´æ¥ç»ˆæ­¢
          else
            echo "âœ… æ— æ®‹ç•™è¿è§„æ–‡ä»¶ï¼"
          fi

          echo -e "\n=== 6. äº§ç‰©è¯¦æƒ…ï¼ˆç¡®è®¤åˆè§„ï¼‰ ==="
          du -sh ./public  # ç¡®è®¤ä½“ç§¯ï¼ˆ2.6MBï¼Œåˆè§„ï¼‰
          ls -la ./public  # æ˜¾ç¤ºæ ¹ç›®å½•æ–‡ä»¶

      # ğŸ”¥ å…³é”®ä¿®å¤ï¼šç”¨ã€Œç®€å•å…¼å®¹ã€çš„æ–¹å¼éªŒè¯äº§ç‰©ï¼ˆæ”¾å¼ƒå¤æ‚tarå‚æ•°ï¼‰
      - name: Validate Artifact (GNU Tar Compatible)
        run: |
          echo "=== éªŒè¯äº§ç‰©æ— é“¾æ¥/ç‰¹æ®Šæ–‡ä»¶ï¼ˆå…¼å®¹ç‰ˆï¼‰ ==="
          # 1. æ‰“åŒ…äº§ç‰©ï¼ˆ--dereference ç¡®ä¿å³ä½¿æœ‰æ¼ç½‘é“¾æ¥ï¼Œä¹Ÿæ‰“åŒ…å®é™…æ–‡ä»¶ï¼‰
          tar -cf /tmp/public.tar --dereference ./public
          echo "âœ… äº§ç‰©æ‰“åŒ…æˆåŠŸ"

          # 2. æ£€æŸ¥æ‰“åŒ…å†…å®¹ï¼šæ˜¯å¦æœ‰ç¬¦å·é“¾æ¥ï¼ˆç¬¦å·é“¾æ¥æƒé™ä»¥ l å¼€å¤´ï¼Œå¦‚ lrwxrwxrwxï¼‰
          LINK_FILES=$(tar -tvf /tmp/public.tar | grep "^l")
          if [ -n "$LINK_FILES" ]; then
            echo "âŒ å‘ç°ç¬¦å·é“¾æ¥æ–‡ä»¶ï¼š"
            echo "$LINK_FILES"
            exit 1
          fi

          # 3. æ£€æŸ¥æ‰“åŒ…å†…å®¹ï¼šæ˜¯å¦æœ‰ç¡¬é“¾æ¥ï¼ˆç¡¬é“¾æ¥ä¼šæ˜¾ç¤º "link to"ï¼‰
          HARD_LINK_FILES=$(tar -tvf /tmp/public.tar | grep "link to")
          if [ -n "$HARD_LINK_FILES" ]; then
            echo "âŒ å‘ç°ç¡¬é“¾æ¥æ–‡ä»¶ï¼š"
            echo "$HARD_LINK_FILES"
            exit 1
          fi

          echo "âœ… äº§ç‰©å®Œå…¨åˆè§„ï¼Œæ— é“¾æ¥/ç‰¹æ®Šæ–‡ä»¶ï¼"

      # ğŸ”¥ ä¸Šä¼ åˆè§„äº§ç‰©
      - name: Upload Validated Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages  # å®˜æ–¹å¼ºåˆ¶åç§°
          path: ./public
          retention-days: 1
          if-no-files-found: error
          overwrite: true

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy to Target Repo GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}