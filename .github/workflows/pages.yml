name: Pages
on:
  push:
    branches: ["gh-pages"]  # è§¦å‘æ¡ä»¶ä¸å˜

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.head_commit.message, 'deploy')}}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm install

      - name: Build
        run: npm run build  # ç¡®ä¿äº§ç‰©è¾“å‡ºåˆ° ./public

      # ğŸ”¥ ç»ˆææ·±åº¦æ¸…ç†ï¼ˆè¦†ç›–æ‰€æœ‰éšè—è¿è§„åœºæ™¯ï¼‰
      - name: Ultimate Cleanup & Visualize All Files
        run: |
          echo "=== 1. æ·±åº¦æ¸…ç†æ‰€æœ‰è¿è§„å†…å®¹ ==="
          # é€’å½’åˆ é™¤æ‰€æœ‰éæ™®é€šæ–‡ä»¶/ç›®å½•ï¼ˆè¦†ç›–æ‰€æœ‰éšè—åœºæ™¯ï¼‰
          find ./public \
            -type l -o -type c -o -type b -o -type p -o -type s -o -type d -empty \
            -print0 | xargs -0 -I {} sh -c 'echo "Deleting invalid: {}"; rm -rf {}'

          # æ›¿æ¢æ‰€æœ‰ç¡¬é“¾æ¥ä¸ºæ™®é€šæ–‡ä»¶ï¼ˆåŒ…æ‹¬æ·±å±‚å­ç›®å½•ï¼‰
          find ./public -type f -links +1 -print0 | xargs -0 -I {} sh -c 'echo "Replacing hardlink: {}"; cp --remove-destination {} {}'

          # å¼ºåˆ¶é‡ç½®æ‰€æœ‰æ–‡ä»¶æƒé™ï¼ˆé¿å…ç‰¹æ®Šæƒé™è¢«æ‹¦æˆªï¼‰
          find ./public -type f -exec chmod 644 {} \;  # æ™®é€šæ–‡ä»¶æƒé™
          find ./public -type d -exec chmod 755 {} \;  # ç›®å½•æƒé™

          # åˆ é™¤æ‰€æœ‰éšè—æ–‡ä»¶ï¼ˆé™¤äº† .html/.css/.js ç­‰å¿…è¦é™æ€æ–‡ä»¶ï¼‰
          find ./public -name ".*" ! -name ".html" ! -name ".css" ! -name ".js" ! -name ".png" ! -name ".jpg" ! -name ".jpeg" ! -name ".gif" ! -name ".svg" -print0 | xargs -0 -I {} sh -c 'echo "Deleting hidden file: {}"; rm -rf {}'

          echo -e "\n=== 2. å¯è§†åŒ–æ‰€æœ‰æ–‡ä»¶ï¼ˆæ—¥å¿—ä¸­å®šä½æœ€åé—®é¢˜ï¼‰ ==="
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæƒé™ã€ç±»å‹ã€è·¯å¾„ï¼‰ï¼Œæ–¹ä¾¿æ’æŸ¥
          echo "All files in public (permission/type/path):"
          find ./public -print0 | xargs -0 ls -la | grep -v "total" | grep -v "drwxr-xr-x" | head -200  # è¿‡æ»¤ç›®å½•ï¼Œæ˜¾ç¤ºæ–‡ä»¶è¯¦æƒ…

          # ç»Ÿè®¡æ–‡ä»¶æ€»æ•°å’Œä½“ç§¯ï¼ˆç¡®è®¤äº§ç‰©æ­£å¸¸ï¼‰
          echo -e "\n=== 3. äº§ç‰©ç»Ÿè®¡ ==="
          find ./public -type f | wc -l  # æ–‡ä»¶æ€»æ•°
          du -sh ./public  # æ€»å¤§å°

          # æœ€ç»ˆéªŒè¯ï¼šæ˜¯å¦è¿˜æœ‰éæ™®é€šæ–‡ä»¶ï¼ˆæ­£å¸¸åº”æ— è¾“å‡ºï¼‰
          INVALID_REMAIN=$(find ./public ! -type f ! -type d)
          if [ -n "$INVALID_REMAIN" ]; then
            echo "âŒ ä»æœ‰æ®‹ç•™è¿è§„ï¼š$INVALID_REMAIN"
            exit 1
          else
            echo "âœ… ç»ˆææ¸…ç†å®Œæˆï¼Œäº§ç‰©ä»…å«æ™®é€šæ–‡ä»¶/ç›®å½•ï¼"
          fi

      # ğŸ”¥ ç®€åŒ–éªŒè¯ï¼ˆäº§ç‰©å·²æ¸…ç†ï¼Œç›´æ¥æ‰“åŒ…ä¸Šä¼ ï¼‰
      - name: Validate & Upload Artifact
        shell: /usr/bin/bash {0}
        run: |
          echo "=== æ‰“åŒ…å¹¶ä¸Šä¼ åˆè§„äº§ç‰© ==="
          tar -cf /tmp/public.tar --dereference ./public  # æ‰“åŒ…éªŒè¯
          echo "âœ… äº§ç‰©æ‰“åŒ…æˆåŠŸï¼Œæ— è¿è§„å†…å®¹"

          # ä¸Šä¼ äº§ç‰©ï¼ˆå®˜æ–¹å¼ºåˆ¶åç§°ï¼‰
          echo "Uploading artifact..."

      - name: Upload Validated Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages
          path: ./public
          retention-days: 1
          if-no-files-found: error
          overwrite: true

  # ğŸ”¥ éƒ¨ç½²æ­¥éª¤ï¼ˆæ·»åŠ é‡è¯•æœºåˆ¶ï¼Œåº”å¯¹å¶å‘ç½‘ç»œé—®é¢˜ï¼‰
  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy to Target Repo GitHub Pages (With Retry)
        id: deploy
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}
        with:
          github_repository: mei-lun/mei-lun
          timeout: 300  # å»¶é•¿è¶…æ—¶æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
          error_count: 3  # å…è®¸3æ¬¡é‡è¯•

      # è¾“å‡ºæœ€ç»ˆç»“æœ
      - name: Show Deployment Result
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼Pages è®¿é—®åœ°å€ï¼š${{ steps.deploy.outputs.page_url }}"