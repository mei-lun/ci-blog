name: ci-blog â†’ mei-lun Pagesï¼ˆé›¶æäº¤ï¼Œä¿®å¤æƒé™ï¼‰
on:
  push:
    branches: ["gh-pages"]  # ä»… ci-blog çš„ gh-pages åˆ†æ”¯è§¦å‘
jobs:
  build-upload:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'deploy')
    steps:
      - name: Checkout ci-blog (gh-pages)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          ref: gh-pages

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm install --production

      - name: Build Static Files
        run: npm run build  # äº§ç‰©è¾“å‡ºåˆ° ./public

      # ğŸ”¥ ä¿®å¤æƒé™ï¼šç”¨ sudo ç¡®ä¿å…¨ç¨‹æœ‰æƒæ“ä½œï¼Œè°ƒæ•´è„šæœ¬é¡ºåº
      - name: Clean & Rebuild Artifactï¼ˆä¿®å¤æƒé™é—®é¢˜ï¼‰
        run: |
          # 1. å…ˆåˆ›å»ºæ–°ç›®å½•ï¼ˆå½“å‰ç”¨æˆ·é»˜è®¤æœ‰æƒé™ï¼‰
          mkdir -p ./final-public
          
          # 2. ç”¨ sudo å¤åˆ¶äº§ç‰©ï¼ˆé¿å…åŸæ–‡ä»¶æƒé™ä¸è¶³ï¼‰
          sudo cp -rL ./public/* ./final-public/  # -Lï¼šè·Ÿéšé“¾æ¥ï¼Œæ–­é“¾åˆè§„
          
          # 3. ç”¨ sudo åˆ é™¤éšè—é£é™©æ–‡ä»¶
          sudo find ./final-public -name ".git" -exec rm -rf {} +
          sudo find ./final-public -name ".DS_Store" -delete
          sudo find ./final-public -name ".*" ! -name ".html" ! -name ".css" ! -name ".js" ! -name ".png" ! -name ".jpg" ! -name ".svg" -delete
          
          # 4. ç”¨ sudo é‡ç½®æƒé™ï¼ˆé¿å… Permission deniedï¼‰
          sudo chmod -R 644 ./final-public/*  # æ™®é€šæ–‡ä»¶æƒé™
          sudo chmod -R 755 ./final-public    # ç›®å½•æƒé™ï¼ˆç¡®ä¿èƒ½è®¿é—®å­ç›®å½•ï¼‰
          
          # 5. éªŒè¯äº§ç‰©åˆè§„ï¼ˆæ— è¿è§„æ–‡ä»¶ï¼‰
          INVALID=$(sudo find ./final-public ! -type f ! -type d)
          [ -n "$INVALID" ] && echo "âŒ Invalid files: $INVALID" && exit 1
          
          du -sh ./final-public
          echo "âœ… äº§ç‰©åˆè§„+æƒé™ä¿®å¤å®Œæˆ"

      - name: Upload Pages Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages  # å®˜æ–¹å¼ºåˆ¶åç§°
          path: ./final-public/
          retention-days: 1
          if-no-files-found: error

  deploy:
    needs: build-upload
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      pages: write  # éƒ¨ç½²å¿…éœ€æƒé™
    steps:
      - name: Deploy to mei-lun GitHub Pagesï¼ˆé›¶æäº¤ï¼‰
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}  # ä½ çš„PATï¼ˆæœ‰æƒæ“ä½œmei-lunçš„Pagesï¼‰