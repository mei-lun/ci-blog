name: Pages
on:
  push:
    branches: ["gh-pages"]  # è§¦å‘æ¡ä»¶ä¸å˜

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.head_commit.message, 'deploy')}}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm install

      - name: Build
        run: npm run build  # ç¡®ä¿äº§ç‰©è¾“å‡ºåˆ° ./public

      # ğŸ”¥ å…³é”®ä¿®å¤1ï¼šArtifact åç§°å¿…é¡»ä¸º "github-pages"ï¼ˆå®˜æ–¹å¼ºåˆ¶çº¦å®šï¼‰
      - name: Upload Pages Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages  # å¿…é¡»æ˜¯è¿™ä¸ªåç§°ï¼deploy-pages åªè®¤è¿™ä¸ª
          path: ./public      # äº§ç‰©ç›®å½•ä¸ build è¾“å‡ºä¸€è‡´
          retention-days: 1  # éƒ¨ç½²åè‡ªåŠ¨æ¸…ç†ï¼Œä¸å ç©ºé—´

  deploy:
    needs: build  # ä¾èµ– build é˜¶æ®µå®Œæˆ
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write  # é…åˆ PAT å®ç°è·¨ä»“åº“èº«ä»½éªŒè¯
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      # ğŸ”¥ å…³é”®ä¿®å¤2ï¼šä¸‹è½½æ—¶ä½¿ç”¨å›ºå®šåç§° "github-pages"
      - name: Download Pages Artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages  # ä¸ä¸Šä¼ æ—¶çš„åç§°å®Œå…¨ä¸€è‡´
          path: ./public      # ä¸‹è½½åˆ° ./publicï¼Œä¿æŒè·¯å¾„ç»Ÿä¸€

      # è·¨ä»“åº“éƒ¨ç½²æ ¸å¿ƒæ­¥éª¤ï¼ˆPAT æˆæƒ + æŒ‡å®šç›®æ ‡ä»“åº“ï¼‰
      - name: Deploy to Target Repo GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
        env:
          # ä¼ å…¥ PAT æˆæƒè·¨ä»“åº“è®¿é—®ï¼ˆå¿…é¡»æœ‰ç›®æ ‡ä»“åº“å†™æƒé™ï¼‰
          GITHUB_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}
        with:
          # æ˜ç¡®æŒ‡å®šç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“åï¼‰
          github_repository: mei-lun/mei-lun
          path: ./public  # éƒ¨ç½²äº§ç‰©ç›®å½•