name: Pages
on:
  push:
    branches: ["gh-pages"]  # è§¦å‘æ¡ä»¶ä¸å˜

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.head_commit.message, 'deploy')}}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"  # ç®€åŒ–ç¼“å­˜é…ç½®

      - name: Install Dependencies
        run: npm install

      - name: Build
        run: npm run build  # ç¡®ä¿äº§ç‰©è¾“å‡ºåˆ° ./public

      # ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šä¸Šä¼ äº§ç‰©åˆ° Artifactï¼ˆä¸æ¨é€åˆ°ä»»ä½•ä»“åº“åˆ†æ”¯ï¼‰
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages-artifact  # Artifact åç§°ï¼ˆå›ºå®šï¼Œåç»­éƒ¨ç½²è¦å¼•ç”¨ï¼‰
          path: ./public  # äº§ç‰©ç›®å½•ï¼ˆä¸ build è¾“å‡ºä¸€è‡´ï¼‰
          retention-days: 1  # äº§ç‰©ä¿ç•™ 1 å¤©ï¼ˆéƒ¨ç½²åè‡ªåŠ¨æ¸…ç†ï¼Œä¸å ç©ºé—´ï¼‰

  # ğŸ”¥ è·¨ä»“åº“éƒ¨ç½²åˆ°ç›®æ ‡ä»“åº“çš„ GitHub Pagesï¼ˆé›¶æäº¤ï¼‰
  deploy:
    needs: build  # ä¾èµ– build é˜¶æ®µçš„ Artifact
    runs-on: ubuntu-latest
    permissions:
      pages: write  # å…è®¸æ“ä½œ Pages
      id-token: write  # å®˜æ–¹èº«ä»½éªŒè¯ï¼ˆé…åˆ PAT è·¨ä»“åº“ï¼‰
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      # ä¸‹è½½ä¹‹å‰ä¸Šä¼ çš„äº§ç‰©
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages-artifact  # ä¸ä¸Šä¼ æ—¶çš„åç§°ä¸€è‡´
          path: ./public  # ä¸‹è½½åˆ° ./public ç›®å½•

      # ğŸ”‘ è·¨ä»“åº“éƒ¨ç½²æ ¸å¿ƒï¼šç”¨ PAT æˆæƒï¼Œç›´æ¥éƒ¨ç½²åˆ°ç›®æ ‡ä»“åº“ Pages
      - name: Deploy to Target Repo GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
        env:
          # ç”¨ PAT æ›¿æ¢é»˜è®¤ä»¤ç‰Œï¼Œæˆæƒè®¿é—®ç›®æ ‡ä»“åº“
          GITHUB_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}
        with:
          # å¼ºåˆ¶æŒ‡å®šç›®æ ‡ä»“åº“çš„ Pages éƒ¨ç½²åœ°å€ï¼ˆè·¨ä»“åº“å…³é”®ï¼‰
          github_repository: mei-lun/mei-lun
          path: ./public  # éƒ¨ç½²äº§ç‰©ç›®å½•